<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>{{ pet.name }} - Tamagochi</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
	<script src="{{ url_for('static', filename='js/phaser.min.js') }}"></script>
</head>
<body>
	<header class="site-header">
		<h1>{{ pet.name }} the {{ pet.pet_type.title() }}</h1>
		<div class="maturity-info" style="font-size: 14px; color: #444;">
			<span id="maturity-stage">Stage: adult</span>
			<span id="maturity-next" style="margin-left: 10px;">Next: --</span>
		</div>
		<nav class="auth-nav">
			<a href="{{ url_for('auth.logout') }}">Logout</a>
		</nav>
	</header>

	<main class="game-main">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes">
                {% for category, message in messages %}
                    <li class="flash {{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}
		<div class="game-layout">
			<div class="game-area">
			<div id="game-container"></div>
			
			<!-- Simple sleep progress bar overlay (always on top) -->
			<div id="simple-sleep-bar" class="simple-sleep-bar" style="display: none;">
				<div class="simple-sleep-content">
					<div class="simple-sleep-header">
						<span style="font-size: 20px;">😴</span>
						<span id="simple-sleep-text">Pet is sleeping...</span>
						<span id="simple-sleep-countdown" style="font-family: monospace; font-weight: bold;">1:00</span>
					</div>
					<div class="simple-progress-bar">
						<div id="simple-progress-fill" class="simple-progress-fill" style="width: 0%;"></div>
					</div>
				</div>
			</div>
			
			<!-- Sleep progress overlay -->
			<div id="sleep-overlay" class="sleep-overlay" style="display: none;">
				<div class="sleep-content">
					<div class="sleep-header">
						<span class="sleep-emoji">😴</span>
						<h3 id="sleep-title">Pet is sleeping...</h3>
					</div>
					<div class="sleep-progress-container">
						<div class="progress-label">Sleep Progress</div>
						<div id="sleep-progress-bar" class="sleep-progress-bar">
							<div id="sleep-progress-fill" class="sleep-progress-fill"></div>
							<div id="sleep-progress-text" class="sleep-progress-text">0%</div>
						</div>
						<div id="sleep-timer" class="sleep-timer">Time remaining: --:--</div>
					</div>
					<p class="sleep-description">Your pet is resting and cannot perform any actions until sleep is complete.</p>
				</div>
			</div>
			
			<!-- Wash progress overlay -->
			<div id="wash-overlay" class="wash-overlay" style="display: none;">
				<div class="wash-content">
					<div class="wash-header">
						<span class="wash-emoji">🚿</span>
						<h3 id="wash-title">Pet is washing...</h3>
					</div>
					<div class="wash-progress-container">
						<div class="progress-label">Wash Progress</div>
						<div id="wash-progress-bar" class="wash-progress-bar">
							<div id="wash-progress-fill" class="wash-progress-fill"></div>
							<div id="wash-progress-text" class="wash-progress-text">0%</div>
						</div>
						<div id="wash-timer" class="wash-timer">Time remaining: --:--</div>
					</div>
					<p class="wash-description">Your pet is washing and cannot perform any actions until washing is complete.</p>
				</div>
			</div>
			
			<!-- Feed progress overlay -->
			<div id="feed-overlay" class="feed-overlay" style="display: none;">
				<div class="feed-content">
					<div class="feed-header">
						<span class="feed-emoji">🍽️</span>
						<h3 id="feed-title">Pet is eating...</h3>
					</div>
					<div class="feed-progress-container">
						<div class="progress-label">Eating Progress</div>
						<div id="feed-progress-bar" class="feed-progress-bar">
							<div id="feed-progress-fill" class="feed-progress-fill"></div>
							<div id="feed-progress-text" class="feed-progress-text">0%</div>
						</div>
						<div id="feed-timer" class="feed-timer">Time remaining: --:--</div>
					</div>
					<p class="feed-description">Your pet is eating and cannot perform any actions until feeding is complete.</p>
				</div>
			</div>
			
			<!-- Play progress overlay -->
			<div id="play-overlay" class="play-overlay" style="display: none;">
				<div class="play-content">
					<div class="play-header">
						<span class="play-emoji">🎮</span>
						<h3 id="play-title">Pet is playing...</h3>
					</div>
					<div class="play-progress-container">
						<div class="progress-label">Playing Progress</div>
						<div id="play-progress-bar" class="play-progress-bar">
							<div id="play-progress-fill" class="play-progress-fill"></div>
							<div id="play-progress-text" class="play-progress-text">0%</div>
						</div>
						<div id="play-timer" class="play-timer">Time remaining: --:--</div>
					</div>
					<p class="play-description">Your pet is playing and cannot perform any actions until playing is complete.</p>
				</div>
			</div>
			
			<!-- Minigame modal -->
			<div id="minigame-modal" class="minigame-modal" style="display: none;">
				<div class="minigame-content">
					<div class="minigame-header">
						<h3>🎮 Minigames</h3>
						<button class="close-btn" id="close-minigame">&times;</button>
					</div>
					<div class="minigame-list">
					<div class="minigame-item" data-game="higher_lower">
						<div class="minigame-icon">🎲</div>
						<div class="minigame-info">
							<div class="minigame-name">Higher or Lower</div>
							<div class="minigame-description">Guess if the number is higher or lower than 10 (Once per day)</div>
							<div class="minigame-requirement">Requires: Joy ≥ 40</div>
							<div class="minigame-status" id="hl-status" style="margin-top: 4px; font-size: 12px; font-weight: 600;"></div>
						</div>
						<button class="play-minigame-btn" id="hl-play-btn" data-game="higher_lower">Play</button>
					</div>
						<div class="minigame-item" data-game="labyrinth">
							<div class="minigame-icon">🏃</div>
							<div class="minigame-info">
								<div class="minigame-name">Labyrinth</div>
								<div class="minigame-description">Navigate the maze, collect all 4 fruits, then find the exit!</div>
								<div class="minigame-requirement">Requires: Joy ≥ 40</div>
							</div>
							<button class="play-minigame-btn" data-game="labyrinth">Play</button>
						</div>
					</div>
				</div>
			</div>
			
			<!-- Higher or Lower Game Interface -->
			<div id="higher-lower-game" class="minigame-modal" style="display: none;">
				<div class="minigame-game-content">
					<div class="game-header">
						<h3>🎲 Higher or Lower</h3>
						<button class="close-btn" id="close-higher-lower">&times;</button>
					</div>
					<div class="game-area">
						<div class="base-number">Base Number: <span id="base-number">10</span></div>
						<div class="game-instruction">Guess if Tamagochi will roll a number higher or lower than 10!</div>
						<div class="guess-buttons">
							<button class="guess-btn" data-guess="lower">Lower</button>
							<button class="guess-btn" data-guess="higher">Higher</button>
						</div>
						<div class="game-result" id="game-result" style="display: none;">
							<div class="result-number" id="result-number"></div>
							<div class="result-message" id="result-message"></div>
							<div class="result-reward" id="result-reward"></div>
							<button class="play-again-btn" id="play-again-btn">Play Again</button>
						</div>
					</div>
				</div>
			</div>
			
			<!-- Labyrinth Game Interface -->
			<div id="labyrinth-game" class="minigame-modal" style="display: none;">
				<div class="minigame-game-content labyrinth-content">
					<div class="game-header">
						<h3>🏃 Labyrinth</h3>
						<button class="close-btn" id="close-labyrinth">&times;</button>
					</div>
					<div class="labyrinth-layout">
						<div class="game-area">
							<div class="game-instruction">Navigate the maze, collect all 4 fruits, then reach the exit!</div>
							<div class="game-stats">
								<div class="collected-items">
									<span class="item-count" id="blueberry-count">🫐 × 0</span>
									<span class="item-count" id="acorn-count">🌰 × 0</span>
								</div>
								<div class="remaining-items" id="remaining-items">Items left: 4</div>
							</div>
							<div class="game-controls">
								<div class="control-hint">Use ↑ ↓ ← → arrow keys to move</div>
							</div>
							<canvas id="labyrinth-canvas" width="480" height="480"></canvas>
						</div>
						<div class="labyrinth-sidebar">
							<div class="game-result" id="labyrinth-result" style="display: none;">
								<div class="result-message" id="labyrinth-message"></div>
								<div class="result-reward" id="labyrinth-reward"></div>
								<div class="result-buttons">
									<button class="play-again-btn" id="labyrinth-play-again">Play Again</button>
									<button class="exit-btn" id="labyrinth-exit">Exit</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<!-- Food selection menu -->
			<div id="food-menu" class="base-menu" style="display: none;">
				<h3>Choose food:</h3>
				<div class="food-options base-menu-options">
					<button class="food-btn base-menu-btn" data-food="mushroom">
						<img src="{{ url_for('static', filename='img/mushroom.png') }}" alt="Mushroom">
						<span>Mushroom (+10) <span class="food-quantity" data-food-type="mushroom">({{ inventory.mushroom if inventory else 0 }})</span></span>
					</button>
					<button class="food-btn base-menu-btn" data-food="blueberries">
						<img src="{{ url_for('static', filename='img/blueberry.png') }}" alt="Blueberries">
						<span>Blueberries (+15) <span class="food-quantity" data-food-type="blueberries">({{ inventory.blueberries if inventory else 0 }})</span></span>
					</button>
					<button class="food-btn base-menu-btn" data-food="tree_seed">
						<img src="{{ url_for('static', filename='img/tree_seed.png') }}" alt="Tree Seed">
						<span>Tree Seed (+5) <span class="food-quantity" data-food-type="tree_seed">({{ inventory.tree_seed if inventory else 0 }})</span></span>
					</button>
					<button class="food-btn base-menu-btn" data-food="acorn">
						<img src="{{ url_for('static', filename='img/acorn.png') }}" alt="Acorn">
						<span>Acorn (+25) <span class="food-quantity" data-food-type="acorn">({{ inventory.acorn if inventory else 0 }})</span></span>
					</button>
				</div>
				<button id="cancel-food" class="base-cancel-btn">Cancel</button>
			</div>
			
			<!-- Sleep selection menu -->
			<div id="sleep-menu" class="base-menu" style="display: none;">
				<h3>Choose rest type:</h3>
				<div class="sleep-options base-menu-options">
					<button class="sleep-btn base-menu-btn" data-sleep="nap">
						<img src="{{ url_for('static', filename='img/squirrel_sofa.png') }}" alt="Nap">
						<span>Nap (+25)</span>
					</button>
					<button class="sleep-btn base-menu-btn" data-sleep="sleep">
						<img src="{{ url_for('static', filename='img/squirrel_bed.png') }}" alt="Sleep">
						<span>Sleep (100)</span>
					</button>
				</div>
				<button id="cancel-sleep" class="base-cancel-btn">Cancel</button>
			</div>
			
			<!-- Wash selection menu -->
			<div id="wash-menu" class="base-menu" style="display: none;">
				<h3>Choose wash type:</h3>
				<div class="wash-options base-menu-options">
					<button class="wash-btn base-menu-btn" data-wash="wash_hands">
						<img src="{{ url_for('static', filename='img/washbasin.png') }}" alt="Wash Hands">
						<span>Wash Hands (+15)</span>
					</button>
					<button class="wash-btn base-menu-btn" data-wash="shower">
						<img src="{{ url_for('static', filename='img/shower_cabin.png') }}" alt="Take Shower">
						<span>Take Shower (+60)</span>
					</button>
				<button class="wash-btn base-menu-btn" data-wash="bath">
					<img src="{{ url_for('static', filename='img/bath.png') }}" alt="Take Bath">
					<span>Take Bath (Full)</span>
				</button>
				</div>
				<button id="cancel-wash" class="base-cancel-btn">Cancel</button>
			</div>
			
			<!-- Play selection menu -->
			<div id="play-menu" class="base-menu" style="display: none;">
				<h3>Choose play activity:</h3>
				<div class="play-options base-menu-options">
					<button class="play-btn base-menu-btn" data-play="play_with_ball">
						<img src="{{ url_for('static', filename='img/tennis_ball.png') }}" alt="Play with Ball">
						<span>Play with Ball (+25)</span>
					</button>
					<button class="play-btn base-menu-btn" data-play="spin_in_wheel">
						<img src="{{ url_for('static', filename='img/play_wheel.png') }}" alt="Spin in the Wheel">
						<span>Spin in the Wheel (+25)</span>
					</button>
				</div>
				<button id="cancel-play" class="base-cancel-btn">Cancel</button>
			</div>
			
			<!-- Storage modal -->
			<div id="storage-modal" class="storage-modal" style="display: none;">
				<div class="storage-content">
					<div class="storage-header">
						<h3>📦 Storage Inventory</h3>
						<button class="close-btn" id="close-storage">&times;</button>
					</div>
					<div class="storage-items">
						<div class="storage-item" data-item="tree_seed">
							<div class="item-icon">
								<img src="{{ url_for('static', filename='img/tree_seed.png') }}" alt="Tree Seed">
							</div>
							<div class="item-info">
								<div class="item-name">Tree Seed</div>
								<div class="item-description">Small nutritious seed (+5 hunger)</div>
							</div>
							<div class="item-quantity" id="storage-tree_seed">{{ inventory.tree_seed if inventory else 0 }}</div>
						</div>

						<div class="storage-item" data-item="blueberries">
							<div class="item-icon">
								<img src="{{ url_for('static', filename='img/blueberry.png') }}" alt="Blueberries">
							</div>
							<div class="item-info">
								<div class="item-name">Blueberries</div>
								<div class="item-description">Sweet and nutritious berries (+15 hunger)</div>
							</div>
							<div class="item-quantity" id="storage-blueberries">{{ inventory.blueberries if inventory else 0 }}</div>
						</div>

						<div class="storage-item" data-item="mushroom">
							<div class="item-icon">
								<img src="{{ url_for('static', filename='img/mushroom.png') }}" alt="Mushroom">
							</div>
							<div class="item-info">
								<div class="item-name">Mushroom</div>
								<div class="item-description">Earthy forest mushroom (+10 hunger)</div>
							</div>
							<div class="item-quantity" id="storage-mushroom">{{ inventory.mushroom if inventory else 0 }}</div>
						</div>

						<div class="storage-item" data-item="acorn">
							<div class="item-icon">
								<img src="{{ url_for('static', filename='img/acorn.png') }}" alt="Acorn">
							</div>
							<div class="item-info">
								<div class="item-name">Acorn</div>
								<div class="item-description">Nutritious nut (+25 hunger)</div>
							</div>
							<div class="item-quantity" id="storage-acorn">{{ inventory.acorn if inventory else 0 }}</div>
						</div>
					</div>
					<div class="storage-footer">
						<p class="storage-note">💡 Use the Feed button to give food to your pet</p>
					</div>
				</div>
			</div>

			<!-- Shop modal -->
			<div id="shop-modal" class="shop-modal" style="display: none;">
				<div class="shop-content">
					<div class="shop-header">
						<h3>🛍️ Pet Shop</h3>
						<button class="close-btn" id="close-shop">&times;</button>
					</div>
					<div class="coin-display">
						<img src="{{ url_for('static', filename='img/coins.png') }}" alt="Coins" class="coin-icon">
						<span class="coin-amount" id="shop-coins">{{ inventory.coins if inventory else 100 }}</span>
						<span class="coin-label">coins</span>
					</div>
					<div class="shop-items">
						<div class="shop-item" data-food="tree_seed" data-price="1">
							<div class="shop-item-icon">
								<img src="{{ url_for('static', filename='img/tree_seed.png') }}" alt="Tree Seed">
							</div>
							<div class="shop-item-info">
								<div class="shop-item-name">Tree Seed</div>
								<div class="shop-item-description">+5 Hunger • Max 100</div>
								<div class="shop-item-price">
									<img src="{{ url_for('static', filename='img/coins.png') }}" alt="Coins" class="price-coin-icon">
									<span class="price-amount">1</span>
									<span class="price-per-unit">each</span>
								</div>
							</div>
							<div class="quantity-selector">
								<button class="qty-btn minus-btn" data-food="tree_seed">-</button>
								<input type="number" class="qty-input" id="qty-tree_seed" value="1" min="1" max="100">
								<button class="qty-btn plus-btn" data-food="tree_seed">+</button>
							</div>
							<div class="purchase-section">
								<div class="total-cost">
									Total: <span id="total-tree_seed">1</span> coins
								</div>
								<button class="buy-btn" id="buy-tree_seed" data-food="tree_seed">
									Buy
								</button>
							</div>
						</div>

						<div class="shop-item" data-food="mushroom" data-price="2">
							<div class="shop-item-icon">
								<img src="{{ url_for('static', filename='img/mushroom.png') }}" alt="Mushroom">
							</div>
							<div class="shop-item-info">
								<div class="shop-item-name">Mushroom</div>
								<div class="shop-item-description">+10 Hunger • Max 100</div>
								<div class="shop-item-price">
									<img src="{{ url_for('static', filename='img/coins.png') }}" alt="Coins" class="price-coin-icon">
									<span class="price-amount">2</span>
									<span class="price-per-unit">each</span>
								</div>
							</div>
							<div class="quantity-selector">
								<button class="qty-btn minus-btn" data-food="mushroom">-</button>
								<input type="number" class="qty-input" id="qty-mushroom" value="1" min="1" max="100">
								<button class="qty-btn plus-btn" data-food="mushroom">+</button>
							</div>
							<div class="purchase-section">
								<div class="total-cost">
									Total: <span id="total-mushroom">2</span> coins
								</div>
								<button class="buy-btn" id="buy-mushroom" data-food="mushroom">
									Buy
								</button>
							</div>
						</div>

						<div class="shop-item" data-food="blueberries" data-price="3">
							<div class="shop-item-icon">
								<img src="{{ url_for('static', filename='img/blueberry.png') }}" alt="Blueberries">
							</div>
							<div class="shop-item-info">
								<div class="shop-item-name">Blueberries</div>
								<div class="shop-item-description">+15 Hunger • Max 100</div>
								<div class="shop-item-price">
									<img src="{{ url_for('static', filename='img/coins.png') }}" alt="Coins" class="price-coin-icon">
									<span class="price-amount">3</span>
									<span class="price-per-unit">each</span>
								</div>
							</div>
							<div class="quantity-selector">
								<button class="qty-btn minus-btn" data-food="blueberries">-</button>
								<input type="number" class="qty-input" id="qty-blueberries" value="1" min="1" max="100">
								<button class="qty-btn plus-btn" data-food="blueberries">+</button>
							</div>
							<div class="purchase-section">
								<div class="total-cost">
									Total: <span id="total-blueberries">3</span> coins
								</div>
								<button class="buy-btn" id="buy-blueberries" data-food="blueberries">
									Buy
								</button>
							</div>
						</div>

						<div class="shop-item" data-food="acorn" data-price="6">
							<div class="shop-item-icon">
								<img src="{{ url_for('static', filename='img/acorn.png') }}" alt="Acorn">
							</div>
							<div class="shop-item-info">
								<div class="shop-item-name">Acorn</div>
								<div class="shop-item-description">+25 Hunger • Max 100</div>
								<div class="shop-item-price">
									<img src="{{ url_for('static', filename='img/coins.png') }}" alt="Coins" class="price-coin-icon">
									<span class="price-amount">6</span>
									<span class="price-per-unit">each</span>
								</div>
							</div>
							<div class="quantity-selector">
								<button class="qty-btn minus-btn" data-food="acorn">-</button>
								<input type="number" class="qty-input" id="qty-acorn" value="1" min="1" max="100">
								<button class="qty-btn plus-btn" data-food="acorn">+</button>
							</div>
							<div class="purchase-section">
								<div class="total-cost">
									Total: <span id="total-acorn">6</span> coins
								</div>
								<button class="buy-btn" id="buy-acorn" data-food="acorn">
									Buy
								</button>
							</div>
						</div>
					</div>
					<div class="shop-footer">
						<p class="shop-note">💰 Buy food to replenish your inventory</p>
					</div>
				</div>
			</div>

			</div>
			
			<div class="game-sidebar">
				<div class="pet-stats">
					<div class="stat-bar">
						<label>Hunger</label>
						<div class="bar">
							<div class="fill hunger-fill" data-value="{{ pet.hunger|default(50) }}"></div>
						</div>
						<span>{{ pet.hunger|default(50) }}%</span>
					</div>
					<div class="stat-bar">
						<label>Joy</label>
						<div class="bar">
							<div class="fill happiness-fill" data-value="{{ pet.happiness|default(50) }}"></div>
						</div>
						<span>{{ pet.happiness|default(50) }}%</span>
					</div>
					<div class="stat-bar">
						<label>Cleanliness</label>
						<div class="bar">
							<div class="fill cleanliness-fill" data-value="{{ pet.cleanliness|default(50) }}"></div>
						</div>
						<span>{{ pet.cleanliness|default(50) }}%</span>
					</div>
					<div class="stat-bar">
						<label>Energy</label>
						<div class="bar">
							<div class="fill energy-fill" data-value="{{ pet.energy|default(50) }}"></div>
						</div>
						<span>{{ pet.energy|default(50) }}%</span>
					</div>
				</div>
				
				<div class="action-buttons">
					<button class="action-btn" data-action="feed">Feed</button>
					<button class="action-btn" data-action="play">Play</button>
					<button class="action-btn" data-action="wash">Wash</button>
					<button class="action-btn" data-action="sleep">Take rest</button>
					<button class="storage-btn" id="storage-btn">📦 Storage</button>
					<button class="shop-btn" id="shop-btn">🛍️ Shop</button>
					<button class="minigame-btn" id="minigame-btn" data-joy="{{ pet.happiness|default(50) }}">🎮 Minigames</button>
				{% if current_user.is_admin %}
				<button class="admin-btn" id="admin-create-user-btn">👤 Create User</button>
				<a class="admin-btn" href="{{ url_for('auth.access_requests_admin') }}">📥 Access Requests</a>
				<a class="admin-btn" href="{{ url_for('auth.admin_users') }}">🧑‍💼 Manage Users</a>
				{% endif %}
				</div>

			{% if current_user.is_admin %}
			<!-- Admin Create User Modal -->
			<div id="admin-create-user-modal" class="storage-modal" style="display:none;">
				<div class="storage-content">
					<div class="storage-header">
						<h3>👤 Create New User</h3>
						<button class="close-btn" id="close-admin-create">&times;</button>
					</div>
					<form method="post" action="{{ url_for('auth.admin_create_user') }}" class="auth-form">
						<label>
							<span>Username</span>
							<input type="text" name="username" required />
						</label>
						<button type="submit">Create</button>
						<p class="storage-note">A temporary password will be generated and shown as a success message. The user must change it on first login.</p>
					</form>
				</div>
			</div>
			{% endif %}
				
				<!-- Test buttons for faster testing -->
				<div class="test-buttons">
					<button class="test-btn" data-test="reduce-hunger">Reduce Hunger (-10)</button>
					<button class="test-btn" data-test="reduce-energy">Reduce Energy (-10)</button>
					<button class="test-btn" data-test="reduce-cleanliness">Reduce Cleanliness (-10)</button>
					<button class="test-btn" data-test="reduce-joy">Reduce Joy (-10)</button>
					<div style="margin-top:8px;">
						<button class="test-btn" id="maturity-down">⏬ Stage Down</button>
						<button class="test-btn" id="maturity-up">⏫ Stage Up</button>
					</div>
				</div>
			</div>
		</div>
	</main>

	<script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
